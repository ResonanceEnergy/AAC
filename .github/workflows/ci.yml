name: AAC CI

on:
  push:
    branches: [main, develop, "feature/**", "fix/**"]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  AAC_ENV: test
  PAPER_TRADING: "true"
  LIVE_TRADING_ENABLED: "false"

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install lint deps
        run: pip install black isort flake8 pre-commit

      - name: black check
        run: black --check --line-length=100 .

      - name: isort check
        run: isort --check-only --profile=black --line-length=100 .

      - name: flake8
        run: flake8 --max-line-length=100 --extend-ignore=E203,W503 --exclude=.venv,archive,build,dist .

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ["3.9", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-timeout pytest-cov

      - name: Create .env for tests
        run: cp .env.template .env

      - name: Run tests
        run: |
          pytest tests/ -q --tb=short --ignore=tests/test_live.py \
            --ignore=tests/security_integration_test.py \
            -m "not live and not exchange and not slow" \
            --timeout=30 \
            --cov=shared --cov=strategies --cov=TradingExecution \
            --cov-report=term-missing --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run pip-audit
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt --ignore-vuln PYSEC-2022-43012

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified

  typecheck:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install mypy types-requests

      - name: Run mypy (core modules)
        run: |
          mypy --ignore-missing-imports --no-error-summary \
            --warn-return-any --warn-unused-configs \
            shared/ core/ TradingExecution/ || true
